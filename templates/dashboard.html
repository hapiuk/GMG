<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Grave Mistake Games</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <!-- Navbar -->
    <div class="navbar" id="navbar">
        <nav>
            <img src="{{ url_for('static', filename='media/images/banner_logo.jpg') }}" id="welcome-banner" alt="Grave Mistake Games">
            <div class="nav-right">
                <a href="#">Dashboard</a> |
                <a href="{{ url_for('logout') }}">Logout</a>
            </div>
        </nav>
    </div>

    <!-- Dashboard Content -->
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6 mb-4">
                <button type="button" class="btn btn-primary btn-block dashboard-button" data-toggle="modal" data-target="#createPostModal">
                    <i class="fas fa-plus-circle"></i><br>
                </button>
            </div>
            <div class="col-md-6 mb-4">
                <button type="button" class="btn btn-warning btn-block dashboard-button" data-toggle="modal" data-target="#viewEditPostsModal">
                    <i class="fas fa-edit"></i><br>
                </button>
            </div>
            <div class="col-md-6 mb-4">
                <button type="button" class="btn btn-info btn-block dashboard-button">
                    <i class="fas fa-cog"></i><br>
                </button>
            </div>
            <div class="col-md-6 mb-4">
                <div class="btn btn-secondary btn-block dashboard-button">
                    <i class="fas fa-chart-bar"></i><br>
                </div>
            </div>
        </div>

        <!-- Create Post Modal -->
        <div class="modal fade" id="createPostModal" tabindex="-1" role="dialog" aria-labelledby="createPostModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form method="POST" action="{{ url_for('create_post') }}" enctype="multipart/form-data">
                        {{ form.hidden_tag() }} <!-- This line includes the CSRF token -->
                        <div class="modal-header">
                            <h5 class="modal-title" id="createPostModalLabel">Create New Post</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="title">Title</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="form-group">
                                <label for="content">Content</label>
                                <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="media_files">Upload Media (Max 3 Images or 1 Video)</label>
                                <input type="file" class="form-control-file" id="media_files" name="media_files" multiple>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Create Post</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </form>                    
                </div>
            </div>
        </div>

        <!-- View & Edit Posts Modal -->
        <div class="modal fade" id="viewEditPostsModal" tabindex="-1" role="dialog" aria-labelledby="viewEditPostsModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewEditPostsModalLabel">View & Edit Posts</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <ul class="list-group">
                            {% for post in posts %}
                            <li class="list-group-item bg-dark">
                                <h5>{{ post.title }}</h5>
                                <p><small>By {{ post.author }} on {{ post.date_posted.strftime('%Y-%m-%d %H:%M:%S') }}</small></p>
                                <p>{{ post.content }}</p>
                                <div class="media-content">
                                    {% for media in post.media %}
                                        {% if media.media_type == 'image' %}
                                            <img src="{{ url_for('uploaded_file', filename=media.media_url.split('/')[-1]) }}" class="post-image img-thumbnail" alt="Post Image">
                                        {% elif media.media_type == 'video' %}
                                            <video controls class="post-video">
                                                <source src="{{ url_for('uploaded_file', filename=media.media_url.split('/')[-1]) }}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <form method="POST" action="{{ url_for('edit_post', post_id=post.id) }}">
                                    {{ form.hidden_tag() }} <!-- This line includes the CSRF token -->
                                    <div class="form-group mt-3">
                                        <label for="title-{{ post.id }}">Edit Title</label>
                                        <input type="text" class="form-control" id="title-{{ post.id }}" name="title" value="{{ post.title }}">
                                    </div>
                                    <div class="form-group">
                                        <label for="content-{{ post.id }}">Edit Content</label>
                                        <textarea class="form-control" id="content-{{ post.id }}" name="content" rows="4">{{ post.content }}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-warning">Update Post</button>
                                    <button type="button" class="btn btn-danger delete-post" data-post-id="{{ post.id }}">Delete Post</button>
                                </form>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/static/js/scripts.js"></script>

    <script>
        // JavaScript to handle the delete action
        document.querySelectorAll('.delete-post').forEach(button => {
            button.addEventListener('click', function () {
                const postId = this.getAttribute('data-post-id');
                if (confirm("Are you sure you want to delete this post?")) {
                    fetch(`/delete_post/${postId}`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token() }}'  // Pass the CSRF token
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            alert("Post deleted successfully.");
                            location.reload();
                        } else {
                            alert("An error occurred. Please try again.");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                }
            });
        });
    </script>
</body>
</html>
